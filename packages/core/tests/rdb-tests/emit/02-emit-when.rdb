// JSDB Emit Functionality Demo - Emit When Condition
// Demonstrates how Emit can be used to control when data is emitted based on conditions
// This test emits results when the record count exceeds 3

// Create streams for the demo
create or replace stream sensor_data;
create or replace stream emit_results;

// Test: Emit when condition is met in summarize
// This will emit results when the temperature exceeds 25 degrees
create flow emit_when_demo as
sensor_data 
  | summarize { 
      record_count: count()
    } 
    emit when temperature > 25
  | assert_or_save_expected("tests/expected/emit-when-demo.ndjson");

// Insert test data for sensor_data (temperature readings)
insert into sensor_data { timestamp: 1000, temperature: 20, location: "room1", sensor_id: "s1" };
insert into sensor_data { timestamp: 2000, temperature: 22, location: "room1", sensor_id: "s1" };
insert into sensor_data { timestamp: 3000, temperature: 25, location: "room1", sensor_id: "s1" };
insert into sensor_data { timestamp: 4000, temperature: 28, location: "room2", sensor_id: "s2" };
insert into sensor_data { timestamp: 5000, temperature: 30, location: "room2", sensor_id: "s2" };
insert into sensor_data { timestamp: 6000, temperature: 32, location: "room2", sensor_id: "s2" };
insert into sensor_data { timestamp: 7000, temperature: 18, location: "room3", sensor_id: "s3" };
insert into sensor_data { timestamp: 8000, temperature: 20, location: "room3", sensor_id: "s3" };

// Flush streams to ensure all processing completes
flush sensor_data;

// List streams to see results
list streams; 